@page
@model ClashSubManager.Pages.Admin.IndexModel
@using Microsoft.Extensions.Localization
@using System.IO
@inject IStringLocalizer<SharedResources> _localizer
@{
    ViewData["Title"] = _localizer["Admin Dashboard"];
    Layout = "_Layout";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>@Localizer["Admin Dashboard"]</h1>
        <p class="text-muted mb-0">@Localizer["Welcome to admin panel"]</p>
    </div>

    <!-- IP Preview Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-hdd-network"></i> @Localizer["CloudflareIP"]</h5>
                    <a href="/admin/cloudflare-ip" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-pencil"></i> @Localizer["Edit"]
                    </a>
                </div>
                <div class="card-body">
                    @if (Model.GlobalIPRecords.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>@Localizer["IPAddress"]</th>
                                        <th>@Localizer["AverageLatency"]</th>
                                        <th>@Localizer["PacketLossRate"]</th>
                                        <th>@Localizer["DownloadSpeed"]</th>
                                        <th>@Localizer["Quality"]</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var ip in Model.GlobalIPRecords.Take(10))
                                    {
                                        var quality = ip.CalculateQuality();
                                        <tr>
                                            <td><code>@ip.IPAddress</code></td>
                                            <td>
                                                <span class="badge @quality.CssClass">
                                                    @ip.AverageLatency
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge @quality.CssClass">
                                                    @ip.PacketLossRate
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">
                                                    @ip.DownloadSpeed
                                                </span>
                                            </td>
                                            <td><span class="badge @quality.CssClass">@quality.Quality</span></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        @if (Model.GlobalIPRecords.Count > 10)
                        {
                            <div class="text-muted small mt-2">
                                @Localizer["Showing"] 10 @Localizer["of"] @Model.GlobalIPRecords.Count @Localizer["Items"]
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                            <p class="mt-2 mb-0">@Localizer["NoIPConfiguration"]</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- YAML Template Preview Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-file-earmark-code"></i> @Localizer["ClashTemplate"]</h5>
                    <a href="/admin/clash-template" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-pencil"></i> @Localizer["Edit"]
                    </a>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.GlobalYAMLContent))
                    {
                        <pre class="bg-light p-3 rounded mb-0" style="max-height: 300px; overflow-y: auto; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.875rem;">@Model.GlobalYAMLContent</pre>
                    }
                    else
                    {
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-file-earmark" style="font-size: 2rem;"></i>
                            <p class="mt-2 mb-0">@Localizer["FileNotExists"]</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Users Preview Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-people"></i> @Localizer["UserConfig"]</h5>
                    <a href="/admin/user-config" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-pencil"></i> @Localizer["Edit"]
                    </a>
                </div>
                <div class="card-body">
                    @if (Model.Users.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>@Localizer["Username"]</th>
                                        <th>@Localizer["DirectoryStatus"]</th>
                                        <th>@Localizer["IPConfiguration"]</th>
                                        <th>@Localizer["ClashTemplateFile"]</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var user in Model.Users.Take(10))
                                    {
                                        var hasConfig = Model.UserConfigStatus.ContainsKey(user) && Model.UserConfigStatus[user];
                                        <tr>
                                            <td><code>@user</code></td>
                                            <td>
                                                <span class="badge @(hasConfig ? "bg-success" : "bg-secondary")">
                                                    @(hasConfig ? Localizer["DirectoryExists"] : Localizer["DirectoryNotExists"])
                                                </span>
                                            </td>
                                            <td>
                                                @if (hasConfig)
                                                {
                                                    var userIPPath = System.IO.Path.Combine("/app/data", user, "cloudflare-ip.csv");
                                                    if (System.IO.File.Exists(userIPPath))
                                                    {
                                                        <span class="badge bg-success">@Localizer["FileExists"]</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-warning">@Localizer["FileNotExists"]</span>
                                                    }
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">-</span>
                                                }
                                            </td>
                                            <td>
                                                @if (hasConfig)
                                                {
                                                    var userYAMLPath = System.IO.Path.Combine("/app/data", user, "clash.yaml");
                                                    if (System.IO.File.Exists(userYAMLPath))
                                                    {
                                                        <span class="badge bg-success">@Localizer["FileExists"]</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-warning">@Localizer["FileNotExists"]</span>
                                                    }
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">-</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        @if (Model.Users.Count > 10)
                        {
                            <div class="text-muted small mt-2">
                                @Localizer["Showing"] 10 @Localizer["of"] @Model.Users.Count @Localizer["Users"]
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-people" style="font-size: 2rem;"></i>
                            <p class="mt-2 mb-0">@Localizer["NoUsersFound"]</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
