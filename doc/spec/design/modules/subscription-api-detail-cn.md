# 用户订阅接口MVP详细设计

**🌐 语言**: [English](subscription-api-detail.md) | [中文](subscription-api-detail-cn.md)

## 1. MVP核心功能

### 1.1 核心价值验证点
- 统一订阅入口：`/sub/[id]` 格式
- 配置拼装：动态合并原始订阅、优选IP、Clash模板
- 完全动态处理：严禁硬编码字段名称或结构

### 1.2 最小功能集
- **GET /sub/[id]**：获取用户Clash订阅配置
- **POST /sub/[id]**：更新用户优选IP配置
- **DELETE /sub/[id]**：删除用户优选IP配置
- **用户ID验证**：通过原始订阅地址验证用户有效性

### 1.3 技术约束
- **.NET 10**：主开发框架
- **ASP.NET Core Razor Pages**：Web开发模式
- **Bootstrap**：前端框架
- **单体应用架构**：严禁前后端分离
- **文件存储**：仅使用本地文件系统

## 2. 核心接口与处理流程

### 2.1 用户订阅接口
- **GET /sub/{id}**：获取用户Clash订阅配置
- **POST /sub/{id}**：更新用户优选IP配置
- **DELETE /sub/{id}**：删除用户优选IP配置

### 2.2 GET /sub/[id] 处理流程
1. **用户验证**：携带Clash User-Agent请求真实订阅地址验证ID
2. **获取订阅**：调用订阅服务API获取用户原始订阅数据
3. **配置加载**：按优先级加载用户专属→默认配置文件
4. **动态合并**：完全动态解析并合并所有字段（模板优先）
5. **IP扩展**：基于proxies进行IP地址扩展
6. **兜底机制**：无配置时直接返回订阅服务原始数据
7. **返回YAML**：Content-Type: text/yaml

### 2.3 用户ID验证机制
- 携带clash的user-agent请求`GET [真实订阅地址]/[用户id]`
- 验证成功：返回yaml文档且HTTP状态码为200
- 验证失败：返回其他内容则用户ID错误

### 2.4 数据覆写范围
1. **proxies扩展**：原`proxies`的`server`属性是域名，复制出与`cloudflare-ip.csv`中IP数量相同的对象，并将server改为IP地址
2. **yaml结构扩展**：读取`clash.yaml`模板，以模板内容为优先项，添加和替换到原内容中
## 3. 兼容性与性能要求

### 3.1 完全动态解析原则
- **严禁硬编码**：不得在代码中预设任何字段名称或结构
- **字段完整性**：完整保留订阅服务和模板文件的所有字段
- **未来兼容性**：自动支持未来Clash版本新增的任何字段
- **动态合并策略**：模板字段优先于订阅字段，相同字段时覆盖

### 3.2 兼容性实现要求
- **完整字段保留**：订阅服务返回的所有字段必须完整保留到最终输出
- **模板字段注入**：clash.yaml中的所有字段必须按原结构注入
- **字段冲突处理**：相同字段名时，模板字段覆盖订阅字段
- **无字段限制**：不得对任何配置字段进行限制、过滤或预设处理

### 3.3 性能约束
- **响应时间**：<100ms（低并发场景）
- **并发处理**：10-50请求/秒
- **内存占用**：<50MB（常驻内存）
- **启动时间**：<30秒
- **文件处理**：CSV最大10MB，YAML最大1MB

### 3.4 安全约束
- **请求限制**：每IP每秒最多10个请求
- **输入验证**：严格的数据格式验证
- **文件操作**：独占写入，原子替换

## 4. 响应与数据格式

### 4.1 标准响应格式
- **成功POST/DELETE**：`Content-Type: application/json`
  ```json
  {"success": true, "message": "操作描述"}
  ```
- **错误响应**：`Content-Type: application/json`
  ```json
  {"success": false, "message": "操作描述"}
  ```

### 4.2 特殊响应
- **GET /sub/[id]**：`Content-Type: text/yaml`，返回完整YAML配置

### 4.3 标准错误码
- `400`：请求参数错误
- `401`：用户ID验证失败
- `403`：权限不足（管理员功能）
- `404`：用户或资源不存在
- `429`：请求频率超限
- `500`：服务器内部错误

### 4.4 数据存储结构
```
/app/data/
├── cloudflare-ip.csv     # 默认优选IP
├── clash.yaml           # 默认Clash模板
├── users.txt            # 用户记录
└── [userId]/            # 用户专属配置
    ├── cloudflare-ip.csv
    └── clash.yaml
```

### 4.5 数据验证规则
- **用户ID**：1-64字符，支持[a-zA-Z0-9_-]
- **IP地址提交**：每行最多1个IP，每次至少1个IP，正则表达式验证
- **CSV文件**：最大10MB，支持CloudflareST格式或纯IP格式
- **YAML模板**：最大1MB，无字段限制
- **并发限制**：每IP每秒10请求

### 4.6 配置优先级
1. 用户专属配置（优先）
2. 默认配置（兜底）
3. 原始订阅（基础）

## 5. MVP实施要点

### 5.1 AI Agent开发范围
- 用户订阅接口实现（GET/POST/DELETE /sub/[id]）
- 完全动态YAML字段解析和合并
- 用户ID验证机制
- 文件存储操作（CSV/YAML读写）
- 订阅服务集成（HTTP请求）

### 5.2 关键技术约束
- **完全动态处理**：动态解析所有字段，严禁硬编码字段名称或结构
- **字段完整性保证**：完整保留订阅服务和模板文件的所有字段
- **函数长度**：不超过50行
- **嵌套限制**：最多3层
- **单体架构**：严禁前后端分离

### 5.3 错误处理策略
- **统一格式**：所有异常返回标准JSON格式
- **关键错误**：用户验证失败、订阅获取失败、文件操作失败
- **标准错误码**：400/401/403/404/429/500

### 5.4 MVP验收标准
- 用户订阅接口正常工作
- 完全动态字段解析和合并
- 符合性能约束条件
- 文件操作并发安全
