# ClashSubManager 客户端扩展功能需求

**🌐 语言**: [English](client-requirements.md) | [中文](client-requirements-cn.md)

> **重要说明**：本文档描述的是ClashSubManager系统的**客户端扩展功能**，属于后续优化模块，非MVP核心功能。系统的核心是服务器端Web应用，提供订阅接口和管理界面。

## 一、功能定位与边界

### 系统架构定位
- **服务器端（核心）**：.NET 10 Web应用，提供订阅接口和管理界面
- **客户端脚本（扩展）**：跨平台脚本程序，用于CloudflareST程序管理和测速结果提交
- **交互关系**：客户端脚本通过调用服务器端API接口实现数据提交

### 扩展功能优先级
- **MVP阶段**：仅实现服务器端核心功能
- **扩展阶段**：根据需要添加客户端脚本支持

### 明确排除的功能
- 用户注册和认证系统
- 数据库存储功能
- 复杂的配置管理界面
- 分布式架构支持
- 高级统计分析功能
- 多用户管理功能

### 扩展功能清单（非MVP）
- **CloudflareST程序管理**：自动检测、下载、跨平台支持
- **用户订阅地址管理**：配置存储、用户ID提取
- **优选IP测速和提交**：CloudflareST集成、API交互

## 二、扩展功能详细设计

* **支持的操作系统**：Windows、Linux、Unix、MacOS
* **部署方式**：脚本文件，放置在 CloudflareST 程序同目录中
* **依赖管理**：自动检测和下载 CloudflareST 程序
* **配置存储**：本地文件存储用户订阅地址（sub.txt）
* **网络通信**：与服务器端 API 进行交互
* **架构模式**：跨平台脚本程序

### 2.1 CloudflareST 程序管理 **[扩展功能]**

**功能描述**：

* 自动检测当前目录是否存在 CloudflareST 程序；
* 若不存在，提供 GitHub 下载页面地址让用户手动下载；
* 支持用户手动输入 CloudflareST 的本地存放位置；
* 根据当前操作系统下载对应版本的 CloudflareST：
  * Windows：下载 `.exe` 版本
  * Linux/Unix：下载对应架构的二进制文件
  * MacOS：下载 macOS 版本


**技术要求**：

* 支持多种架构：x86、x64、ARM64
* 提供下载进度显示
* 错误处理和重试机制
* 跨平台兼容性

---

### 2.2 用户订阅地址管理 **[扩展功能]**

**功能描述**：

* 支持用户输入和保存订阅地址；
* 订阅地址格式：`https://sub.domain.com/sub/[id]`
* 将订阅地址保存在脚本目录下的 `sub.txt` 文件中；

### 2.3 服务器端API集成 **[扩展功能]**

**功能描述**：

* 调用服务器端 `POST /sub/[id]` 接口提交CloudflareST测速结果
* 调用服务器端 `DELETE /sub/[id]` 接口删除用户优选IP配置
* 支持错误重试和状态反馈

**API交互流程**：
1. 读取本地 `sub.txt` 获取用户ID和订阅地址
2. 执行CloudflareST测速程序
3. 解析测速结果文件 `result.csv`
4. 调用服务器端API提交数据
5. 处理响应结果和错误状态

**配置文件格式**：
```
https://sub.domain.com/sub/your-id
```

## 三、与服务器端集成说明

### 3.1 API接口调用
客户端脚本通过调用以下服务器端接口实现功能：

| 接口 | 方法 | 用途 | 数据格式 |
|------|------|------|----------|
| 提交测速结果 | POST /sub/[id] | 创建/更新用户专属优选IP | CSV格式 |
| 删除配置 | DELETE /sub/[id] | 删除用户专属优选IP | - |

### 3.2 数据格式兼容
- **输入格式**：CloudflareST程序输出的result.csv文件
- **提交格式**：符合服务器端API要求的CSV或文本格式
- **响应处理**：解析服务器端JSON响应，处理成功/失败状态

### 3.3 错误处理策略
- **网络错误**：支持重试机制，最多重试3次
- **认证错误**：检查用户ID有效性，提示用户检查订阅地址
- **服务器错误**：记录错误日志，提供用户友好的错误提示

## 四、实施优先级

### 4.1 MVP阶段（服务器端核心）
- **重点**：实现服务器端Web应用核心功能
- **客户端**：暂不实现，通过手动方式提交CloudflareST结果

### 4.2 扩展阶段（客户端支持）
- **优先级1**：基础API调用功能
- **优先级2**：CloudflareST程序管理
- **优先级3**：用户界面和错误处理优化

### 4.3 技术实现建议
- **脚本语言**：根据目标平台选择（PowerShell for Windows, Bash for Linux/Mac）
- **跨平台方案**：可考虑Python等跨平台语言实现
- **打包方式**：单个脚本文件，便于分发和部署

## 五、与现有文档的关系

### 5.1 功能互补性
- **本文档**：描述客户端扩展功能，属于可选模块
- **mvp-outline.md**：描述服务器端核心功能，属于MVP必须实现
- **mvp-boundary.md**：定义服务器端技术边界和约束

### 5.2 接口一致性
客户端脚本调用的API接口在以下文档中有详细定义：
- **server-requirements.md**：第4节"核心接口规范"
- **mvp-boundary.md**：第8节"API接口规范"
- **mvp-core-features.md**：第2节"核心功能定义"

### 5.3 实施建议
1. **MVP阶段**：专注于服务器端功能实现，客户端功能暂缓
2. **扩展阶段**：根据实际需求决定是否实现客户端脚本
3. **集成测试**：客户端实现后需与服务器端进行完整集成测试
