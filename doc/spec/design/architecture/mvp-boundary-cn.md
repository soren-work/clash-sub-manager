# ClashSubManager 技术实施边界规范

> **📌 文档状态**: MVP已完成，本文档作为架构参考保留  
> **🎯 目标读者**: 开发者、贡献者、架构研究者  
> **📅 最后更新**: 2026-02-20  
> **💡 提示**: 如需了解功能使用，请参阅[高级指南](../../../advanced-guide-cn.md)

**🌐 语言**: [English](mvp-boundary.md) | [中文](mvp-boundary-cn.md)

## 1. 核心功能模块边界

### 1.1 用户订阅接口模块

**必须实现的功能：**
- `GET /sub/[id]`：获取完整 Clash 订阅配置
- `POST /sub/[id]`：提交CloudflareST结果，创建/更新用户专属优选IP文件
- `DELETE /sub/[id]`：删除用户专属优选IP文件
- 用户ID验证：通过原始订阅地址验证用户有效性（使用Clash User-Agent请求）
- 动态配置合并：原始订阅 + 优选IP + Clash模板
- 文件存储：用户专属配置和默认配置管理
- 配置优先级：用户专属配置优先于默认配置
- **完全动态处理**：动态解析所有字段，严禁硬编码字段名称或结构
- **字段完整性保证**：完整保留订阅服务和模板文件的所有字段

**禁止实现的功能：**
- 用户注册/创建、密码修改、订阅支付
- API权限控制、细粒度权限管理

### 1.2 管理员认证与权限模块

**必须实现的功能：**
- 环境变量认证：通过Docker环境变量配置管理员
- Cookie会话管理：安全的会话状态管理
- 登录/登出：基础认证操作
- 权限中间件：管理界面访问控制
- 会话超时：自动会话过期机制
- 文件管理界面：对cloudflare-ip.csv和clash.yaml进行管理
- 用户专属配置管理：支持管理/app/data/[用户id]/下的配置文件

**禁止实现的功能：**
- 多管理员账户、角色权限管理、OAuth集成
- API密钥管理、审计日志

### 1.3 默认优选IP管理模块

**必须实现的功能：**
- 统一IP管理界面：管理员可管理全局和用户特定IP配置
- 用户选择器：支持选择全局或特定用户进行操作
- CSV内容管理：支持直接粘贴CSV内容或上传文件，直接覆盖文件
- IP列表展示：表格形式显示优选IP及测速数据，缺失数据显示"无数据"
- IP配置删除：删除整个CSV文件（全局或用户特定）
- 实时生效：修改后立即影响用户订阅生成
- 文件路径管理：全局(/app/data/cloudflare-ip.csv)和用户特定(/app/data/[用户id]/cloudflare-ip.csv)
- CSV解析处理：按result.csv格式解析，支持表头自动跳过
- CloudflareST支持：支持用户脚本提交CloudflareST程序运行结果

**禁止实现的功能：**
- IP测速功能、自动IP筛选、地理位置分析、性能监控

### 1.4 Clash模板管理模块

**必须实现的功能：**
- 模板内容编辑：支持完全动态YAML模板编辑
- 模板文件管理：全局和用户特定模板管理
- 模板删除：删除全局或用户特定模板
- 动态字段处理：完整保留模板中的所有字段，无字段限制

**禁止实现的功能：**
- 模板市场、可视化编辑器、模板版本控制、模板同步

### 1.5 用户专属配置管理模块

**必须实现的功能：**
- 统一配置管理界面：管理员可管理用户专属的IP和模板配置
- 用户选择器：支持选择特定用户查看和管理配置
- 用户列表显示：显示所有访问过的用户ID供选择（从users.txt读取）
- 专属IP配置查看：查看用户的优选IP配置及统计信息
- 专属模板配置查看：查看用户的Clash模板配置
- 配置修改：修改用户专属的IP和模板配置
- 配置删除：删除用户配置文件（IP或模板）
- 配置优先级显示：明确显示专属配置优先于默认配置
- 配置状态显示：显示用户是否配置了专属IP和模板

**禁止实现的功能：**
- 用户信息编辑、批量用户操作、用户分组、用户搜索
- 订阅URL管理（已移至环境变量配置）

## 2. 技术栈约束

### 2.1 允许使用的技术
**核心技术：**
- .NET 10：主要开发框架
- ASP.NET Core Razor Pages：Web开发模式
- Docker：容器化部署
- YAML：配置文件格式
- CSV：数据存储格式

**辅助技术：**
- Bootstrap：前端UI框架
- JavaScript：前端交互逻辑
- HttpClient：网络请求
- File I/O：文件系统操作
- Environment Variables：配置管理

### 2.2 严禁使用的技术
**禁止的技术：**
- 数据库系统：MySQL、PostgreSQL等
- 前端框架：React、Vue、Angular
- 微服务架构、消息队列：Redis、RabbitMQ等
- 搜索引擎：Elasticsearch等

**禁止的架构模式：**
- 前后端分离、微服务、事件驱动
- CQRS、DDD等复杂架构模式

### 2.3 扩展性约束
**允许的扩展点：**
- 配置格式扩展：可支持新的配置文件格式
- 验证规则扩展：可增加新的数据验证规则
- UI主题扩展：可支持不同的UI主题
- 日志格式扩展：可支持不同的日志输出格式

**严禁的扩展点：**
- 数据存储扩展：严禁扩展到数据库存储
- 架构模式扩展：严禁改变单体架构
- 通信协议扩展：严禁增加gRPC、WebSocket等
- 部署模式扩展：严禁支持Kubernetes等复杂部署

## 3. 数据处理约束

### 3.1 支持的数据格式
**文件格式：**
- YAML文件：Clash配置模板（.yaml/.yml）
- CSV文件：优选IP数据（.csv）
- 文本文件：用户ID列表（.txt）
- JSON格式：API响应格式

**数据结构限制：**
- 用户ID长度：1-64字符
- CSV文件大小：最大10MB
- YAML文件大小：最大1MB
- IP地址验证：使用正则表达式提取和验证IP地址
- CSV提交要求：每行最多1个IP地址，至少包含1个IP地址

### 3.2 严禁的数据处理
**禁止的数据操作：**
- 数据库查询、文件系统遍历、网络爬虫
- 数据挖掘、数据交易

**禁止的数据格式：**
- 二进制文件、压缩文件、加密文件、多媒体文件

## 4. 安全约束

### 4.1 允许的安全措施
**基础安全功能：**
- 环境变量认证：管理员凭据配置
- Cookie会话管理：安全的会话处理

### 4.2 严禁的安全功能
**禁止的安全特性：**
- 复杂权限系统：RBAC等复杂权限
- API密钥管理、双因子认证、审计日志、入侵检测

## 5. 性能要求

### 5.1 必须满足的性能指标
- 响应时间：<100ms（低并发场景）
- 并发处理：10-50请求/秒
- 内存占用：<50MB（常驻内存）
- 启动时间：<30秒
- 文件处理：支持最大10MB文件
- **完全动态处理**：支持完全动态的YAML字段解析和合并，严禁硬编码任何字段名称或结构

### 5.2 不追求的性能指标
- 高并发处理：不追求1000+并发
- 低延迟优化：不追求ms级延迟优化
- 大规模数据处理：不支持GB级数据处理
- 分布式性能、复杂缓存策略

## 6. 兼容性约束

### 6.1 支持的兼容性
**平台兼容性：**
- 操作系统：Linux、Windows（通过Docker）
- 浏览器：现代浏览器（Chrome、Firefox、Safari、Edge）
- Clash版本：支持标准Clash配置格式
- Docker版本：支持主流Docker版本

**数据兼容性：**
- Clash配置：标准YAML格式
- CSV格式：标准逗号分隔值
- HTTP协议：标准HTTP/HTTPS
- JSON格式：标准JSON数据格式

### 6.2 不支持的兼容性
- 旧版浏览器：IE等旧版浏览器
- 移动端适配：MVP不专门适配移动端
- 其他代理工具：不支持其他代理配置格式
- 数据库兼容、云平台集成

## 7. 部署约束

### 7.1 支持的部署方式
- Docker容器：标准Docker部署
- 环境变量配置：通过环境变量配置
- 单机部署：单机容器部署
- 数据卷映射：外部数据目录映射

### 7.2 不支持的部署方式
- Kubernetes、集群部署、云平台特定
- 微服务部署、有状态服务

## 8. API接口规范

### 8.1 核心API接口
- `GET /sub/[用户id]` - 获取覆写后的订阅数据
- `POST /sub/[用户id]` - 提交CloudflareST结果
- `DELETE /sub/[用户id]` - 删除用户专属IP文件
- 管理员登录和管理接口

### 8.2 响应格式规范
**标准响应格式：**
- 成功响应：`{"success": true, "message": "操作描述"}`
- 错误响应：`{"success": false, "message": "操作描述"}`

**特殊响应：**
- `GET /sub/[id]`：返回完整YAML配置（Content-Type: text/yaml）

**标准错误码：**
- `400`：请求参数错误
- `401`：用户ID验证失败
- `403`：权限不足（管理员功能）
- `404`：用户或资源不存在
- `429`：请求频率超限
- `500`：服务器内部错误

### 8.3 数据格式规范
**POST /sub/[id] 请求格式：**
- Content-Type：`text/csv` 或 `text/plain`
- 数据格式：CSV格式或自由文本格式，支持CloudflareST输出
- 验证规则：每行最多包含1个IP地址，每次提交至少包含1个IP地址

### 8.4 系统配置规范
**订阅URL配置：**
- 环境变量：`SUBSCRIPTION_URL_TEMPLATE`
- 支持URL模板：路径参数、查询参数、固定URL
- 自动替换：`{userId}` 占位符替换为实际用户ID

**用户管理：**
- 用户记录文件：`/app/data/users.txt`
- 自动去重：首次访问时自动记录用户ID
- 简化管理：仅记录用户ID，无复杂配置

### 8.4 核心处理逻辑
**GET /sub/[用户id] 处理流程：**
1. 携带clash的user-agent请求`GET [真实订阅地址]/[用户id]`
2. 验证成功：返回yaml文档且HTTP状态码为200
3. 验证失败：返回其他内容则用户ID错误
4. 兜底策略：当既无用户专属配置也无默认配置时，直接返回clash订阅接口的原始数据

**覆写范围：**
1. **proxies的扩展**：原`proxies`的`server`属性是域名，在此基础上将其复制出与`cloudflare-ip.csv`文件中ip地址数量相同的对象，并将server改为文件中的ip地址
2. **yaml文档结构的扩展**：读取`clash.yaml`文件中定义好的模板与设定，以`clash.yaml`文件中的内容为优先项，以原内容为次优先项，将`clash.yaml`文件的内容添加和替换到原内容中

**兼容性要求：**
- **完全动态处理**：必须动态解析和处理clash.yaml模板及订阅服务返回的所有字段，严禁硬编码任何字段名称或结构
- **字段完整性保证**：完整保留订阅服务返回的所有字段，同时完整包含clash.yaml模板中的所有字段
- **无字段限制**：不得对任何配置字段进行限制、过滤或预设处理

### 8.5 优先级应用规则
1. 用户专属文件优先于全局文件
2. clash.yaml模板内容优先于原订阅内容
3. IP扩展基于现有proxies进行复制和修改
4. **动态字段处理**：所有字段必须动态解析，严禁硬编码字段名称或结构
5. **完整字段保留**：订阅服务和模板文件的所有字段必须完整保留到最终输出

